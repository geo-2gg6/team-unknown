<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Privacy Scanner - Global Network Monitor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .pulse { animation: pulse 2s infinite; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-900 text-white min-h-screen">
    <div class="container mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">üîí Privacy Scanner</h1>
            <p class="text-gray-400">Monitor your browser's network activity in real-time</p>
            <div class="mt-4 text-sm text-gray-500">
                üåç Works globally - no installation required
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">
            <!-- Session Info -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üì± Session Info</h2>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>Session ID:</span>
                        <span id="session-id" class="font-mono text-sm">Loading...</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Browser:</span>
                        <span id="browser-info" class="text-sm">Detecting...</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Status:</span>
                        <span id="monitoring-status" class="text-green-400">Active</span>
                    </div>
                </div>
            </div>

            <!-- Quick Stats -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üìä Network Stats</h2>
                <div id="stats" class="space-y-2">
                    <div class="flex justify-between">
                        <span>Total Requests:</span>
                        <span id="total-requests" class="font-mono">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Safe:</span>
                        <span id="safe-count" class="text-green-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Risk:</span>
                        <span id="risk-count" class="text-red-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Caution:</span>
                        <span id="caution-count" class="text-yellow-400 font-mono">0</span>
                    </div>
                    <div class="flex justify-between">
                        <span>Unique Domains:</span>
                        <span id="unique-domains" class="font-mono">0</span>
                    </div>
                </div>
            </div>

            <!-- Controls -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">üéõÔ∏è Controls</h2>
                <div class="space-y-3">
                    <button id="start-monitoring" class="w-full bg-green-600 hover:bg-green-700 px-4 py-2 rounded">
                        üöÄ Start Monitoring
                    </button>
                    <button id="stop-monitoring" class="w-full bg-red-600 hover:bg-red-700 px-4 py-2 rounded hidden">
                        ‚èπÔ∏è Stop Monitoring
                    </button>
                    <button id="clear-data" class="w-full bg-gray-600 hover:bg-gray-700 px-4 py-2 rounded">
                        üóëÔ∏è Clear Data
                    </button>
                    <div class="text-xs text-gray-400 mt-2">
                        Monitor network requests as you browse
                    </div>
                </div>
            </div>
        </div>

        <!-- Network Activity -->
        <div class="bg-gray-800 rounded-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold">üîç Network Activity</h2>
                <div class="flex items-center space-x-4">
                    <span id="last-update" class="text-sm text-gray-400"></span>
                    <div class="flex items-center space-x-2">
                        <div class="w-2 h-2 bg-green-400 rounded-full" id="status-indicator"></div>
                        <span class="text-sm" id="status-text">Monitoring</span>
                    </div>
                </div>
            </div>
            
            <div id="events-container" class="space-y-3 max-h-96 overflow-y-auto">
                <div class="text-center text-gray-400 py-8">
                    <div class="text-4xl mb-2">üåê</div>
                    <div>Ready to monitor your network activity</div>
                    <div class="text-sm mt-2">Click "Start Monitoring" to begin tracking requests</div>
                </div>
            </div>
        </div>

        <!-- Instructions -->
        <div class="mt-8 bg-blue-900/20 border border-blue-500/30 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-3 text-blue-300">üìñ How It Works</h3>
            <div class="text-sm text-gray-300 space-y-2">
                <p>‚Ä¢ <strong>Start Monitoring:</strong> Begin tracking network requests from this browser session</p>
                <p>‚Ä¢ <strong>Browse Normally:</strong> Visit websites, use apps - we'll track the requests</p>
                <p>‚Ä¢ <strong>Real-time Analysis:</strong> See which domains are Safe, Risky, or Caution</p>
                <p>‚Ä¢ <strong>Privacy Focused:</strong> All data stays in your browser session, not stored permanently</p>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let isMonitoring = false;
        let sessionId = generateSessionId();
        let requestCount = 0;
        let events = [];

        // DOM elements
        const eventsContainer = document.getElementById('events-container');
        const startBtn = document.getElementById('start-monitoring');
        const stopBtn = document.getElementById('stop-monitoring');
        const clearBtn = document.getElementById('clear-data');
        const sessionIdEl = document.getElementById('session-id');
        const browserInfoEl = document.getElementById('browser-info');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            sessionIdEl.textContent = sessionId.substring(0, 12) + '...';
            browserInfoEl.textContent = getBrowserInfo();
            updateStats();
        });

        // Event listeners
        startBtn.addEventListener('click', startMonitoring);
        stopBtn.addEventListener('click', stopMonitoring);
        clearBtn.addEventListener('click', clearData);

        // Generate unique session ID
        function generateSessionId() {
            return 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // Get browser info
        function getBrowserInfo() {
            const ua = navigator.userAgent;
            if (ua.includes('Chrome')) return 'Chrome';
            if (ua.includes('Firefox')) return 'Firefox';
            if (ua.includes('Safari')) return 'Safari';
            if (ua.includes('Edge')) return 'Edge';
            return 'Unknown Browser';
        }

        // Start monitoring
        function startMonitoring() {
            if (isMonitoring) return;
            
            isMonitoring = true;
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            statusIndicator.className = 'w-2 h-2 bg-green-400 rounded-full pulse';
            statusText.textContent = 'Monitoring';
            
            // Start tracking navigation
            trackNavigation();
            
            // Start periodic sync
            setInterval(syncEvents, 2000);
            
            console.log('üîç Started monitoring network activity');
        }

        // Stop monitoring
        function stopMonitoring() {
            isMonitoring = false;
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            statusIndicator.className = 'w-2 h-2 bg-gray-400 rounded-full';
            statusText.textContent = 'Stopped';
            
            console.log('‚èπÔ∏è Stopped monitoring');
        }

        // Track page navigation and requests
        function trackNavigation() {
            // Track current page
            trackRequest(window.location.href, 'navigation');
            
            // Track when user navigates away
            window.addEventListener('beforeunload', function() {
                trackRequest(window.location.href, 'navigation');
            });
            
            // Track clicks on links
            document.addEventListener('click', function(e) {
                if (e.target.tagName === 'A' && e.target.href) {
                    setTimeout(() => {
                        trackRequest(e.target.href, 'click');
                    }, 100);
                }
            });
            
            // Track form submissions
            document.addEventListener('submit', function(e) {
                if (e.target.action) {
                    trackRequest(e.target.action, 'form');
                }
            });
            
            // Enhanced fetch monitoring
            const originalFetch = window.fetch;
            window.fetch = function(...args) {
                const url = args[0];
                if (typeof url === 'string') {
                    trackRequest(url, 'fetch');
                }
                return originalFetch.apply(this, args)
                    .then(response => {
                        // Track successful responses
                        if (response.ok) {
                            trackRequest(url, 'fetch-success');
                        }
                        return response;
                    })
                    .catch(error => {
                        // Track failed requests
                        trackRequest(url, 'fetch-error');
                        throw error;
                    });
            };
            
            // Monitor XMLHttpRequest
            const originalXHR = window.XMLHttpRequest;
            window.XMLHttpRequest = function() {
                const xhr = new originalXHR();
                const originalOpen = xhr.open;
                const originalSend = xhr.send;
                
                xhr.open = function(method, url, ...args) {
                    this._method = method;
                    this._url = url;
                    trackRequest(url, 'xhr');
                    return originalOpen.apply(this, [method, url, ...args]);
                };
                
                xhr.send = function(...args) {
                    if (this._url) {
                        trackRequest(this._url, 'xhr-send');
                    }
                    return originalSend.apply(this, args);
                };
                
                return xhr;
            };
            
            // Monitor image loads
            const originalImage = window.Image;
            window.Image = function() {
                const img = new originalImage();
                const originalSrc = Object.getOwnPropertyDescriptor(HTMLImageElement.prototype, 'src');
                Object.defineProperty(img, 'src', {
                    get: originalSrc.get,
                    set: function(value) {
                        if (value && typeof value === 'string') {
                            trackRequest(value, 'image');
                        }
                        return originalSrc.set.call(this, value);
                    }
                });
                return img;
            };
            
            // Monitor script loads
            const originalCreateElement = document.createElement;
            document.createElement = function(tagName) {
                const element = originalCreateElement.call(this, tagName);
                if (tagName.toLowerCase() === 'script') {
                    const originalSrc = Object.getOwnPropertyDescriptor(HTMLScriptElement.prototype, 'src');
                    Object.defineProperty(element, 'src', {
                        get: originalSrc.get,
                        set: function(value) {
                            if (value && typeof value === 'string') {
                                trackRequest(value, 'script');
                            }
                            return originalSrc.set.call(this, value);
                        }
                    });
                }
                return element;
            };
            
            // Monitor CSS loads
            const originalCreateElement2 = document.createElement;
            document.createElement = function(tagName) {
                const element = originalCreateElement2.call(this, tagName);
                if (tagName.toLowerCase() === 'link') {
                    const originalHref = Object.getOwnPropertyDescriptor(HTMLLinkElement.prototype, 'href');
                    Object.defineProperty(element, 'href', {
                        get: originalHref.get,
                        set: function(value) {
                            if (value && typeof value === 'string') {
                                trackRequest(value, 'css');
                            }
                            return originalHref.set.call(this, value);
                        }
                    });
                }
                return element;
            };
            
            // Monitor iframe loads
            document.addEventListener('DOMContentLoaded', function() {
                const iframes = document.querySelectorAll('iframe');
                iframes.forEach(iframe => {
                    if (iframe.src) {
                        trackRequest(iframe.src, 'iframe');
                    }
                });
            });
            
            // Monitor WebSocket connections
            const originalWebSocket = window.WebSocket;
            window.WebSocket = function(url, ...args) {
                trackRequest(url, 'websocket');
                return new originalWebSocket(url, ...args);
            };
            
            // Monitor EventSource (Server-Sent Events)
            const originalEventSource = window.EventSource;
            window.EventSource = function(url, ...args) {
                trackRequest(url, 'eventsource');
                return new originalEventSource(url, ...args);
            };
        }

        // Track a network request
        function trackRequest(url, type) {
            if (!isMonitoring) return;
            
            const event = {
                url: url,
                type: type,
                timestamp: Date.now() / 1000,
                method: 'GET',
                status: 'pending'
            };
            
            events.unshift(event);
            if (events.length > 100) {
                events = events.slice(0, 100);
            }
            
            requestCount++;
            updateDisplay();
            updateStats();
        }

        // Sync events with server
        async function syncEvents() {
            if (!isMonitoring || events.length === 0) return;
            
            try {
                const response = await fetch('/api/browser-events', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        session_id: sessionId,
                        events: events.slice(0, 10) // Send latest 10 events
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'success') {
                        // Remove synced events
                        events = events.slice(10);
                    }
                }
            } catch (error) {
                console.log('Sync error:', error);
            }
        }

        // Update display
        function updateDisplay() {
            if (events.length === 0) {
                eventsContainer.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        <div class="text-4xl mb-2">üåê</div>
                        <div>No network activity detected</div>
                        <div class="text-sm mt-2">Browse some websites to see requests</div>
                    </div>
                `;
                return;
            }

            const html = events.map(event => {
                const domain = extractDomain(event.url);
                const verdict = classifyDomain(domain);
                const colorBg = verdict === 'Risk' ? 'bg-red-600/20' : 
                              verdict === 'Safe' ? 'bg-green-600/15' : 'bg-yellow-600/15';
                const textColor = verdict === 'Risk' ? 'text-red-300' : 
                                verdict === 'Safe' ? 'text-green-300' : 'text-yellow-300';
                
                const timestamp = new Date(event.timestamp * 1000).toLocaleTimeString();
                const typeIcon = getTypeIcon(event.type);
                
                return `
                    <div class="p-4 rounded-lg ${colorBg} border border-gray-700 fade-in">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-lg">${typeIcon} ${escapeHtml(domain)}</div>
                                <div class="text-sm text-gray-400 mt-1">
                                    ${escapeHtml(event.type)} ‚Ä¢ ${escapeHtml(timestamp)}
                                </div>
                                <div class="text-sm text-gray-300 mt-1 truncate">
                                    ${escapeHtml(event.url)}
                                </div>
                            </div>
                            <div class="text-right">
                                <div class="text-lg font-bold ${textColor}">${escapeHtml(verdict)}</div>
                                <div class="text-xs text-gray-400">${escapeHtml(event.method)}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            eventsContainer.innerHTML = html;
        }

        // Update statistics
        function updateStats() {
            const stats = events.reduce((acc, event) => {
                const domain = extractDomain(event.url);
                const verdict = classifyDomain(domain);
                acc.total++;
                if (verdict === 'Safe') acc.safe++;
                else if (verdict === 'Risk') acc.risk++;
                else if (verdict === 'Caution') acc.caution++;
                return acc;
            }, { total: 0, safe: 0, risk: 0, caution: 0 });

            document.getElementById('total-requests').textContent = stats.total;
            document.getElementById('safe-count').textContent = stats.safe;
            document.getElementById('risk-count').textContent = stats.risk;
            document.getElementById('caution-count').textContent = stats.caution;
            document.getElementById('unique-domains').textContent = new Set(events.map(e => extractDomain(e.url))).size;
            
            document.getElementById('last-update').textContent = `Last updated: ${new Date().toLocaleTimeString()}`;
        }

        // Clear all data
        function clearData() {
            events = [];
            requestCount = 0;
            updateDisplay();
            updateStats();
            console.log('üóëÔ∏è Cleared all data');
        }

        // Utility functions
        function extractDomain(url) {
            try {
                const urlObj = new URL(url);
                return urlObj.hostname;
            } catch {
                return url;
            }
        }

        function classifyDomain(domain) {
            const trusted = [
                'google.com', 'gstatic.com', 'googleapis.com', 'microsoft.com',
                'github.com', 'amazonaws.com', 'cloudflare.com', 'facebook.com',
                'youtube.com', 'netflix.com', 'spotify.com'
            ];
            
            const risky = [
                'doubleclick.net', 'adservice.google.com', 'googlesyndication.com',
                'googletagmanager.com', 'analytics', 'tracking', 'tracker'
            ];
            
            const domainLower = domain.toLowerCase();
            
            if (trusted.some(pattern => domainLower.includes(pattern))) {
                return 'Safe';
            }
            if (risky.some(pattern => domainLower.includes(pattern))) {
                return 'Risk';
            }
            return 'Caution';
        }

        function getTypeIcon(type) {
            const icons = {
                'navigation': 'üåê',
                'click': 'üëÜ',
                'form': 'üìù',
                'fetch': 'üì°',
                'fetch-success': '‚úÖ',
                'fetch-error': '‚ùå',
                'xhr': 'üì°',
                'xhr-send': 'üì§',
                'image': 'üñºÔ∏è',
                'script': 'üìú',
                'css': 'üé®',
                'iframe': 'üñºÔ∏è',
                'websocket': 'üîå',
                'eventsource': 'üì°',
                'default': 'üîó'
            };
            return icons[type] || icons.default;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>